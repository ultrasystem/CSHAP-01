***************
*** 28,34 ****
  #include <linux/sched.h>
  #include <linux/async.h>
  #include <linux/suspend.h>
- 
  #include "../base.h"
  #include "power.h"
  
--- 28,34 ----
  #include <linux/sched.h>
  #include <linux/async.h>
  #include <linux/suspend.h>
+ #include <linux/cpuidle.h>
  #include "../base.h"
  #include "power.h"
  
***************
*** 1049,1056 ****
  int dpm_suspend_end(pm_message_t state)
  {
  	int error = dpm_suspend_late(state);
  
- 	return error ? : dpm_suspend_noirq(state);
  }
  EXPORT_SYMBOL_GPL(dpm_suspend_end);
  
--- 1051,1066 ----
  int dpm_suspend_end(pm_message_t state)
  {
  	int error = dpm_suspend_late(state);
+ 	if (error)
+ 		return error;
+ 
+ 	error = dpm_suspend_noirq(state);
+ 	if (error) {
+ 		dpm_resume_early(state);
+ 		return error;
+ 	}
  
+ 	return 0;
  }
  EXPORT_SYMBOL_GPL(dpm_suspend_end);
  
